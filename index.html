<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Sight Reading Exercise (Maximized Layout)</title>
<style>
  :root{
    /* 테마 색상 */
    --ndc-bg-grad: linear-gradient(135deg, #bfeee3 0%, #ffd8ba 50%, #bcd9f5 100%);
    --ndc-card: rgba(255,255,255,0.65);
    --ndc-card-soft: rgba(245,248,250,.5);
    --ndc-text: #1c2c38;
    --ndc-sub: #385858;
    --ndc-border: rgba(100,150,200,.3);
    --ndc-border-strong: rgba(100,150,200,.5);
    --ndc-accent-1: #3fb3ff; 
    --ndc-accent-2: #ff914d; 
    --ndc-shadow-1: 0 12px 28px rgba(100,150,200,.15);

    /* 레이아웃 변수 (여백 감소) */
    --gap: clamp(8px, 1.2vw, 16px); /* 갭 축소 */
    --radius: 16px;
    
    /* Note Sizing */
    --system-gap: clamp(8px, 1.2vh, 16px);
    /* 기본 노트 높이 */
    --note-h: clamp(80px, 15vh, 200px); 
    --barline-w: 2px;
  }

  *{box-sizing:border-box}
  html, body { height: 100%; min-height: 100dvh; margin: 0; padding: 0; overflow: hidden; }

  body{
    background: var(--ndc-bg-grad) fixed;
    color: var(--ndc-text);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    -webkit-font-smoothing: antialiased;
  }

  /* --- 구조: Stage (중앙 정렬) > ScaleWrap > Main --- */
  #stage{
    width: 100vw; height: 100vh; height: 100dvh;
    display: flex; 
    justify-content: center; 
    align-items: center; 
    overflow: hidden;
  }
  #scaleWrap { transform-origin: center center; width: 100%; }

  main {
    width: 100%;
    max-width: 1600px; /* 최대 폭 허용 범위 증가 */
    margin: 0 auto;
    /* 전체 패딩 대폭 감소 */
    padding: clamp(4px, 1vw, 10px);
  }

  /* Layout Split: PC/가로 모드 */
  .layout-split {
    display: flex;
    flex-direction: column;
    gap: var(--gap);
  }

  @media (min-aspect-ratio: 4/3) {
    .layout-split {
      display: grid;
      /* 컨트롤 패널 너비 280px 고정, 나머지는 악보 */
      grid-template-columns: 280px 1fr; 
      align-items: center; 
      gap: 20px; /* 패널 간 간격 축소 (기존 40px -> 20px) */
    }
    .panel-left {
      display: flex; flex-direction: column; gap: 16px;
    }
    .panel-right {
      display: flex; flex-direction: column;
      justify-content: center;
    }
  }

  /* --- 카드 & 패널 --- */
  .card, .panel {
    background: var(--ndc-card);
    backdrop-filter: blur(10px);
    border-radius: var(--radius);
    box-shadow: var(--ndc-shadow-1);
    padding: 16px; /* 패딩 약간 축소 */
    border: 1px solid rgba(255,255,255,0.4);
  }

  header { text-align: center; margin-bottom: 8px; }
  @media (min-aspect-ratio: 4/3) { header { text-align: left; } }

  h1 {
    margin: 0;
    font-size: clamp(24px, 4vw, 36px); /* 타이틀 사이즈 조정 */
    color: #ffffff;
    -webkit-text-stroke: 1px black;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    line-height: 1.1;
  }

  /* --- 컨트롤 요소 --- */
  .control-group { display: flex; flex-direction: column; gap: 14px; }
  .row { display: flex; align-items: center; gap: 8px; justify-content: space-between; }
  .label { font-size: 12px; font-weight: 700; color: var(--ndc-sub); margin-bottom: 4px; display:block; }
  
  /* 버튼 디자인 */
  select, .btn, .counter {
    background: rgba(255,255,255,0.4);
    color: var(--ndc-text);
    border: 1px solid var(--ndc-border);
    border-radius: 10px;
    padding: 0 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.1s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    height: 40px; 
    display: inline-flex; align-items: center; justify-content: center;
  }
  select { width: 100%; appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 10px center; background-size: 10px; }
  
  .btn:hover, select:hover {
    background: rgba(255,255,255,0.7);
    border-color: var(--ndc-border-strong);
  }
  .btn:active, .btn.active {
    background: linear-gradient(135deg, rgba(255,145,77,.25), rgba(63,179,255,.25));
    border-color: var(--ndc-accent-1);
    color: #000;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.4);
  }

  /* 상단 컨트롤 (Mode + Level) */
  .top-controls { display: flex; gap: 8px; width: 100%; }
  .top-controls .btn { flex: 1; }
  .top-controls select { flex: 1.2; }

  /* BPM / Sig 섹션 */
  .bpm-row { display: flex; gap: 10px; width: 100%; align-items: flex-end; }
  .bpm-group { flex: 2; } 
  .sig-group { flex: 1; min-width: 70px; }
  
  .counter { padding: 4px; width: 100%; justify-content: space-between; background: rgba(255,255,255,0.3); }
  .counter .btn { 
    width: 28px; height: 32px; padding: 0; margin: 0; border: none; background: transparent; box-shadow: none; font-size: 18px; 
  }
  .counter .btn:hover { background: rgba(255,255,255,0.5); border-radius: 6px; }
  .counter .value { font-size: 18px; font-weight: 800; font-variant-numeric: tabular-nums; min-width: 40px; text-align: center; }

  /* 액션 버튼 */
  .action-buttons { display: flex; gap: 8px; width: 100%; }
  .action-buttons .btn { flex: 1; font-size: 15px; font-weight: 700; }
  #btnStart.playing { background: rgba(63,179,255,0.25); border-color: var(--ndc-accent-1); box-shadow: 0 0 0 2px var(--ndc-accent-1) inset; }

  /* --- 악보 시스템 (Seamless) --- */
  .systems { display: grid; row-gap: var(--system-gap); width: 100%; }
  .system { display: flex; width: 100%; justify-content: center; }
  
  .bar {
    flex: 1; position: relative;
    margin: 0 3px; 
    background: transparent;
  }
  .barClip {
    display: flex; justify-content: center;
    padding: 0; 
    overflow: hidden;
    border-radius: 12px; 
    background: var(--ndc-card);
    border: 1px solid rgba(255,255,255,0.5);
    box-shadow: 0 6px 16px rgba(100,150,200,0.1);
    height: var(--note-h);
  }
  
  /* Bar 제목 숨김 요청 반영 */
  .barTitle {
    display: none;
  }

  .strip { 
    display: flex; width: 100%; height: 100%; 
    align-items: stretch; 
    gap: 0; 
  }
  
  .note {
    flex: 1; display: flex; align-items: center; justify-content: center;
    position: relative; cursor: pointer;
    border: none; 
    margin: 0; padding: 0;
    overflow: hidden;
  }
  
  .note img {
    width: 100.5%; 
    height: 100%; 
    display: block;
    object-fit: fill; 
    user-select: none;
  }
  
  /* 하이라이트 */
  .note.playing::after {
    content:""; position:absolute; inset: 0;
    background: rgba(63,179,255,0.2);
    border-bottom: 5px solid var(--ndc-accent-1);
    pointer-events: none;
  }
  .note.marked::after {
    content:""; position:absolute; inset: 0;
    background: rgba(255,145,77,0.15);
    border: 2px solid var(--ndc-accent-2);
    pointer-events: none;
  }

  /* --- 팔레트 --- */
  #palettePanel { margin-top: 12px; display: none; }
  .paletteRow { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
  .swatch {
    background: var(--ndc-card-soft);
    border: 1px solid var(--ndc-border);
    border-radius: 8px; padding: 6px;
    cursor: pointer; width: 64px; display: flex; flex-direction: column; align-items: center;
  }
  .swatch img { width: 100%; height: auto; }
  .swatch.active { outline: 2px solid var(--ndc-accent-1); background: white; }

  /* --- 전체화면 버튼 --- */
  .fs-btn {
    position: fixed; top: 12px; right: 12px;
    width: 44px; height: 44px; border-radius: 50%;
    background: rgba(0,0,0,0.6); color: #fff;
    border: none; cursor: pointer; z-index: 1000;
    display: grid; place-items: center;
  }
  .fs-btn:hover { transform: scale(1.1); }
  .icon { width: 22px; height: 22px; }
  .icon.exit { display: none; }

  /* --- [세로 모드 최적화] --- */
  @media (orientation: portrait) {
    :root { 
      --note-h: clamp(70px, 11vh, 110px); 
      --gap: 10px;
    }
    #stage { align-items: flex-start; padding-top: 2vh; } 
    .layout-split { display: flex; gap: 16px; }
    .panel-left { width: 100%; }
    
    .card { padding: 14px; }
    h1 { font-size: 24px; margin-bottom: 6px; }
    .label { font-size: 11px; margin-bottom: 2px; }
    
    select, .btn, .counter { height: 40px; font-size: 14px; }
    .action-buttons { margin-top: 4px; }
    .panel-right { padding-bottom: 40px; overflow: visible; }
  }
</style>
</head>
<body>

<div id="stage">
  <div id="scaleWrap">
    <main class="layout-split">
      
      <div class="panel-left">
        <header>
          <h1>Sight Reading Exercise</h1>
        </header>

        <div class="card control-group">
          
          <div>
            <span class="label">Mode & Level</span>
            <div class="top-controls">
              <button id="btnStudy" class="btn active" type="button">Study</button>
              <button id="btnChallenge" class="btn" type="button">Chall.</button>
              <select id="level" aria-label="Level">
                <option value="1" selected>Lv 1</option><option value="2">Lv 2</option><option value="3">Lv 3</option>
                <option value="4">Lv 4</option><option value="5">Lv 5</option><option value="6">Lv 6</option>
                <option value="7">Lv 7</option><option value="8">Lv 8</option><option value="9">Lv 9</option>
                <option value="10">Lv 10</option><option value="11">Lv 11</option><option value="12">Lv 12</option>
                <option value="13">Lv 13</option><option value="14">Lv 14</option><option value="15">Lv 15</option>
              </select>
            </div>
          </div>

          <div class="bpm-row">
            <div class="bpm-group">
              <span class="label">BPM</span>
              <div class="counter">
                <button class="btn" id="bpmMinus5" type="button">-5</button>
                <button class="btn" id="bpmMinus1" type="button">-</button>
                <span class="value" id="bpmVal">60</span>
                <button class="btn" id="bpmPlus1" type="button">+</button>
                <button class="btn" id="bpmPlus5" type="button">+5</button>
              </div>
            </div>
            <div class="sig-group">
              <span class="label">Sig</span>
              <select id="sig"><option value="4/4" selected>4/4</option><option value="3/4">3/4</option></select>
            </div>
          </div>

          <div>
            <div class="action-buttons">
              <button class="btn" id="btnStart" type="button">Start</button>
              <button class="btn" id="btnStop" type="button">Stop</button>
              <button class="btn" id="btnRefresh" type="button" title="Refresh (R)">Reset</button>
            </div>
          </div>

        </div>
      </div>

      <div class="panel-right">
        <div id="systems" class="systems" aria-label="exercise systems"></div>
        
        <section class="card" id="palettePanel">
          <div id="paletteRow1" class="paletteRow"></div>
          <div id="paletteRow2" class="paletteRow" style="margin-top:6px"></div>
        </section>
      </div>

    </main>
  </div>
</div>

<button id="fsBtn" class="fs-btn" aria-label="Toggle Fullscreen (F)">
  <svg class="icon enter" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 10V4h6m10 10v6h-6M4 4l7 7m9 9l-7-7" stroke-linecap="round" stroke-linejoin="round"/></svg>
  <svg class="icon exit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 4H4v6m10 10h6v-6M11 11L4 4m9 9l7 7" stroke-linecap="round" stroke-linejoin="round"/></svg>
</button>

<script>
(function() { 'use strict';
  // --- Constants & State ---
  const MAX_IMAGE=15;
  const SLOTS_44=4, SLOTS_34=3;
  const PATTERN = {0:"xxxx",1:"oxxx",2:"oxox",3:"oooo",4:"ooox",5:"oxoo",6:"xxox",7:"xxoo",8:"ooxo",9:"oxxo",10:"ooxx",11:"xooo",12:"xoox",13:"xxxo",14:"xoxo",15:"xoxx"};

  let mode = 'study'; 
  let bpm=60, playing=false, slotsPerBar=SLOTS_44, barsCount=4, seq=[], selectedIdx=null;
  let endHoldUntil = null;
  let paletteSel = 1; 
  let seqSnap = null; 
  let noteCells = [];

  // --- Image Loader ---
  function candidatePaths(n){
    const base = ['Images','images','./Images','./images'];
    const exts = ['png','PNG','webp','jpg','jpeg'];
    const list=[]; base.forEach(b=> exts.forEach(e=> list.push(`${b}/${n}.${e}`))); return list;
  }
  function loadImg(n){
    return new Promise((resolve,reject)=>{
      const list = candidatePaths(n); let i=0;
      const tryNext=()=>{
        if(i>=list.length) return reject(new Error('not found'));
        const img = new Image();
        img.onload=()=>resolve(img);
        img.onerror=()=>{ i++; tryNext(); };
        img.src=list[i];
      };
      tryNext();
    });
  }

  // --- Audio (Synth) ---
  const ctx = new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'});

  function generateSnareSound(time) {
    if (!ctx) return;
    const noiseBuffer = ctx.createBuffer(1, ctx.sampleRate * 0.18, ctx.sampleRate);
    const data = noiseBuffer.getChannelData(0);
    for (let i = 0; i < noiseBuffer.length; i++) data[i] = Math.random() * 2 - 1;
    const noise = ctx.createBufferSource(); noise.buffer = noiseBuffer;
    const hp = ctx.createBiquadFilter(); hp.type = 'highpass'; hp.frequency.setValueAtTime(1200, time);
    const bp = ctx.createBiquadFilter(); bp.type = 'bandpass'; bp.frequency.setValueAtTime(2500, time); bp.Q.setValueAtTime(0.8, time);
    const g = ctx.createGain(); g.gain.setValueAtTime(0.6, time); g.gain.exponentialRampToValueAtTime(0.01, time + 0.12);
    noise.connect(hp).connect(bp).connect(g).connect(ctx.destination);
    noise.start(time); noise.stop(time + 0.18);
  }

  function generateClickSound(time, accent=false) {
    if (!ctx) return;
    const osc = ctx.createOscillator();
    const g = ctx.createGain();
    osc.type = 'square';
    osc.frequency.setValueAtTime(accent ? 1500 : 1200, time);
    g.gain.setValueAtTime(accent ? 0.25 : 0.18, time);
    g.gain.exponentialRampToValueAtTime(0.0001, time + 0.04);
    osc.connect(g).connect(ctx.destination);
    osc.start(time); osc.stop(time + 0.05);
  }

  // --- Scheduler ---
  const lookahead = 0.05, scheduleAhead = 0.20;
  let nextNoteIdx = 0, nextNoteTime = 0, endIdx = 0, tickId = null;
  let preCountLeft = 0;
  let visualTimers = [], scheduledSources = [];
  const PRE_LEAD = 0.25; 

  const $=s=>document.querySelector(s);
  const beatDur = ()=> 60/Math.max(30,bpm);
  const beatsOf=s=>s==='3/4'?3:4;
  function setBPM(v){ bpm=Math.max(30,Math.min(240,v)); $('#bpmVal').textContent=String(bpm); }

  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

  function makeDiverseBar(level, slots){
    const pool = Array.from({length:level+1}, (_,i)=>i);
    const bar = new Array(slots);
    const positions = shuffle(Array.from({length:slots}, (_,i)=>i));
    bar[positions[0]] = level;
    if(slots>1) bar[positions[1%slots]] = 0;
    for(let i=0;i<slots;i++) if(bar[i]===undefined){
      const used={}; bar.forEach(v=>{ if(v!==undefined) used[v]=(used[v]||0)+1; });
      const cand = pool.slice().sort((a,b)=>(used[a]||0)-(used[b]||0));
      bar[i]=cand[0];
    }
    return bar;
  }

  function generateStudy(level, slots){
    const BARS_STUDY = 4;
    const out=new Array(slots*BARS_STUDY);
    const studyNote = Math.max(1, Math.min(level, MAX_IMAGE));
    for(let i=0;i<slots*2;i++) out[i]=studyNote;
    const b3 = makeDiverseBar(level, slots);
    const b4 = makeDiverseBar(level, slots);
    for(let i=0;i<slots*2;i++) out[slots*2+i]=b3[i];
    for(let i=0;i<slots;i++) out[slots*3+i]=b4[i];
    barsCount = BARS_STUDY;
    return out;
  }

  function generateChallenge(level, slots){
    const BARS_CHALLENGE = 8;
    const pool = Array.from({length:level+1}, (_,i)=>i);
    const total = slots*BARS_CHALLENGE;
    const out = new Array(total).fill(null);
    const pos = shuffle(Array.from({length:total}, (_,i)=>i));
    let k=0; for(const n of shuffle(pool.slice())) if(k<pos.length) out[pos[k++]]=n;
    const used={}; pool.forEach(n=> used[n]=0); out.forEach(n=>{ if(n!==null) used[n]++; });
    for(let i=0;i<total;i++) if(out[i]===null){ const s=pool.slice().sort((a,b)=>used[a]-used[b]); out[i]=s[0]; used[s[0]]++; }
    for(let block=0; block<BARS_CHALLENGE/2; block++){
      const start=block*2*slots, end=start+2*slots;
      let has=false; for(let i=start;i<end;i++){ if(out[i]===level){ has=true; break; } }
      if(!has){ let rep=start; const freq={}; for(let i=start;i<end;i++){ const n=out[i]; freq[n]=(freq[n]||0)+1; if(freq[n] >= (freq[out[rep]]||0)) rep=i; } out[rep]=level; }
    }
    barsCount = BARS_CHALLENGE;
    return out;
  }

  // --- Build UI ---
  async function buildPalette(){
    const row1 = document.getElementById('paletteRow1');
    const row2 = document.getElementById('paletteRow2');
    if(!row1 || !row2) return;
    row1.innerHTML=''; row2.innerHTML='';
    const makeSw = async (n)=>{
      const sw = document.createElement('div');
      sw.className='swatch'+(n===paletteSel?' active':'');
      try{ const img = await loadImg(n); sw.appendChild(img); }catch{ sw.textContent=n; }
      sw.addEventListener('click', ()=>{
        paletteSel = n;
        document.querySelectorAll('.swatch.active').forEach(x=>x.classList.remove('active'));
        sw.classList.add('active');
      });
      return sw;
    };
    const loads = [];
    for(let n=0;n<=15;n++){
      const p = makeSw(n).then(sw=> (n<=7? row1 : row2).appendChild(sw));
      loads.push(p);
    }
    await Promise.all(loads);
  }

  async function build(){
    const systems=$('#systems'); systems.innerHTML='';
    const level=Math.min(parseInt($('#level').value,10), MAX_IMAGE);
    const sig=$('#sig').value; slotsPerBar=(sig==='3/4'?SLOTS_34:SLOTS_44);

    if(mode==='custom'){
      document.getElementById('palettePanel').style.display='block';
      await buildPalette();
      seq = new Array(slotsPerBar*4).fill(0); barsCount = 4;
    }else{
      document.getElementById('palettePanel').style.display='none';
      seq = (mode==='study') ? generateStudy(level, slotsPerBar) : generateChallenge(level, slotsPerBar);
    }

    const rows = Math.ceil(barsCount/2);
    for(let row=0; row<rows; row++){
      const sys=document.createElement('div'); sys.className='system';
      for(let col=0; col<2; col++){
        const barIndex=row*2+col;
        if(barIndex>=barsCount) break;
        const bar=document.createElement('div');
        bar.className='bar';
        
        const clip=document.createElement('div'); clip.className='barClip';
        const strip=document.createElement('div'); strip.className='strip';
        const title=document.createElement('div'); title.className='barTitle'; title.textContent=`Bar ${barIndex+1}`;
        bar.appendChild(title);

        const loads=[];
        for(let i=0;i<slotsPerBar;i++){
          const idx = barIndex*slotsPerBar+i;
          const n=seq[idx];
          const p=loadImg(n).then(img=>{
            img.alt=n; 
            const wrap=document.createElement('div'); wrap.className='note';
            if(mode==='custom'){
              wrap.addEventListener('click', ()=>{
                seq[idx]=paletteSel;
                replaceNoteImage(wrap, seq[idx]);
              });
            }else{
              wrap.addEventListener('click', ()=>{
                const barStart = Math.floor(idx/slotsPerBar)*slotsPerBar;
                document.querySelectorAll('.note').forEach(n=>n.classList.remove('marked'));
                const cells = Array.from(document.querySelectorAll('.note'));
                if(cells[barStart]) cells[barStart].classList.add('marked');
                selectedIdx = barStart;
              });
            }
            wrap.appendChild(img); strip.appendChild(wrap);
          }).catch(()=>{
            const wrap=document.createElement('div'); wrap.className='note';
            wrap.textContent='['+n+']'; strip.appendChild(wrap);
          });
          loads.push(p);
        }
        await Promise.all(loads);
        clip.appendChild(strip); bar.appendChild(clip); sys.appendChild(bar);
      }
      systems.appendChild(sys);
    }

    noteCells = Array.from(document.querySelectorAll('.note'));
    await waitImagesLoaded();
    setTimeout(applyVerticalFit, 50);
  }

  function replaceNoteImage(container, n){
    const old = container.querySelector('img'); if(old) old.remove();
    loadImg(n).then(img=>{ container.appendChild(img); }).catch(()=>{ container.textContent=n; });
  }

  function waitImagesLoaded(){
    const imgs = Array.from(document.querySelectorAll('.note img'));
    return Promise.all(imgs.map(im=> im.complete? Promise.resolve() : new Promise(r=>{ im.onload=r; im.onerror=r; })));
  }

  function clearHighlights(){ noteCells.forEach(n=>n.classList.remove('playing','marked')); }
  function setHighlight(idx){
    const c = noteCells[idx]; if(!c) return;
    noteCells.forEach(n=>n.classList.remove('playing'));
    c.classList.add('playing');
  }

  function scheduleVisual(idx, when){
    const delayMs = Math.max(0, Math.round((when - ctx.currentTime)*1000));
    const id = setTimeout(()=> setHighlight(idx), delayMs);
    visualTimers.push(id);
  }

  function schedulerTick(){
    const now = ctx.currentTime;
    if(endHoldUntil && now >= endHoldUntil){ endHoldUntil = null; stop(); return; }
    while (playing && nextNoteTime < now + scheduleAhead){
      if(preCountLeft>0){
        generateClickSound(nextNoteTime);
        preCountLeft--;
        nextNoteTime += beatDur();
        continue;
      }
      if(nextNoteIdx >= endIdx){
        const bdur = beatDur();
        endHoldUntil = (endHoldUntil || now) + bdur * 1.0 + 0.15;
        break;
      }
      const idx = nextNoteIdx++;
      generateClickSound(nextNoteTime);
      scheduleVisual(idx, nextNoteTime);
      const n = seqSnap[idx];
      const pat = PATTERN[n] || 'xxxx';
      const bdur = beatDur();
      for(let k=0;k<4;k++) if(pat[k]==='o') generateSnareSound(nextNoteTime + k*(bdur/4));
      nextNoteTime += bdur;
    }
  }

  function startScheduler(){ if(tickId) return; tickId = setInterval(schedulerTick, lookahead*1000); }
  function stopScheduler(){ if(tickId){ clearInterval(tickId); tickId=null; } }

  async function start(){
    if(playing) return;
    playing = true;
    endHoldUntil = null;
    await ctx.resume();
    clearHighlights();
    seqSnap = seq.slice();
    noteCells = Array.from(document.querySelectorAll('.note'));

    if(mode==='custom'){
      document.getElementById('palettePanel').style.pointerEvents='none';
      document.getElementById('palettePanel').style.opacity='0.5';
    }
    document.getElementById('btnStart').classList.add('playing');
    
    const total = noteCells.length;
    const startAt = (selectedIdx!=null)? selectedIdx : 0;
    nextNoteIdx = startAt;
    endIdx = total;
    preCountLeft = beatsOf($('#sig').value);
    nextNoteTime = ctx.currentTime + PRE_LEAD;
    startScheduler();
  }

  function stop(){
    playing = false;
    stopScheduler();
    visualTimers.forEach(id=> clearTimeout(id)); visualTimers = [];
    clearHighlights();
    document.getElementById('btnStart').classList.remove('playing');
    if(mode==='custom'){
      document.getElementById('palettePanel').style.pointerEvents='';
      document.getElementById('palettePanel').style.opacity='';
    }
  }

  // --- Listeners ---
  document.getElementById('btnStart').addEventListener('click', start);
  document.getElementById('btnStop').addEventListener('click', stop);
  
  const bpmBtn = (id, val) => document.getElementById(id).addEventListener('click', ()=> setBPM(bpm+val));
  bpmBtn('bpmMinus5', -5); bpmBtn('bpmMinus1', -1);
  bpmBtn('bpmPlus1', 1); bpmBtn('bpmPlus5', 5);

  document.getElementById('level').addEventListener('change', ()=>{ stop(); build(); });
  document.getElementById('sig').addEventListener('change',   ()=>{ stop(); build(); });

  function setMode(m){
    if(mode===m) return;
    mode=m;
    document.getElementById('btnStudy').classList.toggle('active', mode==='study');
    document.getElementById('btnChallenge').classList.toggle('active', mode==='challenge');
    stop(); build();
  }
  document.getElementById('btnStudy').addEventListener('click', ()=> setMode('study'));
  document.getElementById('btnChallenge').addEventListener('click', ()=> setMode('challenge'));
  
  window.refreshExercise = function(){
      const keepLevel = $('#level').value;
      const keepSig   = $('#sig').value;
      const keepBpm   = $('#bpmVal').textContent;
      stop();
      $('#level').value = keepLevel;
      $('#sig').value   = keepSig;
      $('#bpmVal').textContent = keepBpm;
      bpm = parseInt(keepBpm,10) || 60;
      selectedIdx=null;
      build();
  };
  document.getElementById("btnRefresh").addEventListener("click", window.refreshExercise);

  document.addEventListener('keydown',e=>{
    if(e.repeat || e.target.tagName==='INPUT' || e.target.tagName==='SELECT') return;
    if(e.code==='Space'){ e.preventDefault(); playing ? stop() : start(); }
    if(e.code==='Enter'){ e.preventDefault(); stop(); selectedIdx=null; clearHighlights(); }
    if(e.code==='KeyR'){ e.preventDefault(); window.refreshExercise(); }
    if(e.code==='ArrowLeft')  setBPM(bpm-5); 
    if(e.code==='ArrowRight') setBPM(bpm+5);
    if(e.code==='ArrowUp'){ e.preventDefault(); const el=$('#level'); if(+el.value<15){ el.value= +el.value+1; stop(); build(); }}
    if(e.code==='ArrowDown'){ e.preventDefault(); const el=$('#level'); if(+el.value>1){ el.value= +el.value-1; stop(); build(); }}
    
    // New Hotkeys: Q / W
    if(e.key==='q' || e.key==='Q'){ setMode('study'); }
    if(e.key==='w' || e.key==='W'){ setMode('challenge'); }
  });

  function isPhoneLike(){
    const mq = window.matchMedia('(hover: none) and (pointer: coarse) and (max-width: 600px)');
    if (mq && mq.matches) return true;
    return window.innerWidth <= 600 && /mobile/i.test(navigator.userAgent);
  }

  function applyVerticalFit(){
    const wrap = document.getElementById('scaleWrap');
    const stage = document.getElementById('stage');
    if(!wrap || !stage) return;
    wrap.style.transform = 'none';
    wrap.style.width = '100%';
    if (isPhoneLike()) return;

    const contentH = wrap.scrollHeight;
    const contentW = wrap.scrollWidth;
    const viewH = stage.clientHeight;
    const viewW = stage.clientWidth;
    if(contentH <= 0 || contentW <= 0) return;

    let scale = viewH / contentH;
    if (contentW * scale > viewW) scale = viewW / contentW;
    
    // ** 화면 채우기 로직 변경 ** // 기존 1.0 제한을 1.35(35% 확대 허용)로 늘려 여백 감소
    scale = Math.min(scale, 1.35);
    
    wrap.style.transform = `scale(${scale})`;
    wrap.style.width = `calc(100% / ${scale})`;
  }

  const fsBtn = document.getElementById('fsBtn');
  const fsEnterIcon = fsBtn.querySelector('.icon.enter');
  const fsExitIcon  = fsBtn.querySelector('.icon.exit');
  const isFullscreen = () => document.fullscreenElement || document.webkitFullscreenElement;

  async function toggleFullscreen() {
    try {
      if (isFullscreen()) {
        if (document.exitFullscreen) await document.exitFullscreen();
        else if (document.webkitExitFullscreen) await document.webkitExitFullscreen();
      } else {
        const el = document.documentElement;
        if (el.requestFullscreen) await el.requestFullscreen();
        else if (el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
      }
    } catch(e){ console.error(e); }
  }
  function updateFsUI() {
    const fs = !!isFullscreen();
    fsBtn.setAttribute('aria-pressed', fs);
    fsEnterIcon.style.display = fs ? 'none' : 'block';
    fsExitIcon.style.display = fs ? 'block' : 'none';
    setTimeout(applyVerticalFit, 100);
  }
  fsBtn.addEventListener('click', toggleFullscreen);
  document.addEventListener('fullscreenchange', updateFsUI);
  document.addEventListener('keydown', e=>{
    if(e.key==='f'||e.key==='F'){ toggleFullscreen(); }
    if(e.key==='Escape' && isFullscreen()){ toggleFullscreen(); }
  });

  window.addEventListener('resize', applyVerticalFit);
  window.addEventListener('orientationchange', ()=> setTimeout(applyVerticalFit, 100));
  build();
})();
</script>
</body>
</html>
